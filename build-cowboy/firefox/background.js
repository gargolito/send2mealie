(()=>{"use strict";"undefined"!=typeof browser&&browser.runtime;const e="undefined"!=typeof browser?browser:chrome,t=e.action||e.browserAction;function i(){if(t?.openPopup)try{t.openPopup()}catch(e){console.log("Send2Mealie: Popup cannot be opened programmatically")}}const r="undefined"!=typeof browser?browser:chrome,n=r.action||r.browserAction,a=new Map;function o(e){n?.setBadgeText&&a.has(e)&&(a.delete(e),n.setBadgeText({text:"",tabId:e}),n.setTitle?.({tabId:e,title:"Send to Mealie"}))}async function s(e,t,i){try{const r=new URL("/api/recipes",t),n=JSON.stringify(e||"");r.search=new URLSearchParams({page:1,perPage:1,queryFilter:`orgURL = ${n}`}).toString();const a=await fetch(r.href,{method:"GET",headers:{Authorization:`Bearer ${i}`,Accept:"application/json"}});if(!a.ok)return null;const o=await a.json();return o?.items?.length>0?o.items[0]:null}catch(e){return null}}r.runtime.onInstalled.addListener(()=>{}),r.tabs.onUpdated.addListener(async(t,i,s)=>{if("complete"===i.status)try{if(!s.url)return;const i=(await r.storage.sync.get({userSites:[]})||{}).userSites||[];if(0===i.length)return void o(t);const c=new URL(s.url).hostname.replace(/^www\./,""),l=i.find(e=>c.endsWith(e));if(l)try{await async function(t,i){if(e.scripting?.executeScript)return e.scripting.executeScript({target:{tabId:t},files:i});for(const r of i)await e.tabs.executeScript(t,{file:r})}(t,["contentScript.js"]),o(t)}catch(e){/Missing host permission|Cannot access contents of the page/i.test(e?.message||"")?(console.warn("Send2Mealie: Missing host permission for tab",t,l),function(e,t){n?.setBadgeText&&a.get(e)!==t&&(a.set(e,t),n.setBadgeBackgroundColor?.({color:"#d93025",tabId:e}),n.setBadgeText({text:"!",tabId:e}),n.setTitle?.({tabId:e,title:`Grant Send2Mealie permission for ${t} via the popup`}))}(t,l)):console.error("Send2Mealie: Error injecting content script",e)}else o(t)}catch(e){console.error("Send2Mealie: Error in tabs.onUpdated listener",e)}}),n?.onClicked&&n.onClicked.addListener(e=>{r.storage.sync.get(["mealieUrl","mealieApiToken"]).then(t=>{t.mealieUrl&&t.mealieApiToken?async function(e,t,i){try{const n=new URL("/api/recipes/create/url",t).href,a=await fetch(n,{method:"POST",headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"},body:JSON.stringify({url:e})});if(!a.ok)throw new Error("Failed to send recipe");await a.json(),r.notifications?.create({type:"basic",title:"Sent to Mealie",iconUrl:"icon-128.png",message:"Recipe URL submitted."})}catch(e){r.notifications?.create({type:"basic",title:"Mealie error",iconUrl:"icon-128.png",message:"Failed to send recipe"})}}(e.url,t.mealieUrl,t.mealieApiToken):i()})}),r.runtime.onMessage.addListener((e,t,n)=>"createViaApi"===e?.type&&e.url?((async()=>{const t=await r.storage.sync.get(["mealieUrl","mealieApiToken","enableDuplicateCheck"]),{mealieUrl:a,mealieApiToken:o,enableDuplicateCheck:c}=t;if(!a||!o)return i(),void n({success:!1});try{if(c){const t=await s(e.url,a,o);if(t)return void n({success:!1,error:"Recipe already imported",duplicate:!0,recipe:t})}const t=new URL("/api/recipes/create/url",a).href,i=await fetch(t,{method:"POST",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},body:JSON.stringify({url:e.url})});if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);await i.json(),n({success:!0})}catch(e){n({success:!1,error:"Failed to send recipe"})}})(),!0):"checkDuplicate"===e?.type&&e.url?((async()=>{const t=await r.storage.sync.get(["mealieUrl","mealieApiToken"]),{mealieUrl:i,mealieApiToken:a}=t;if(i&&a)try{const t=await s(e.url,i,a);n({exists:!!t})}catch(e){n({exists:!1})}else n({exists:!1})})(),!0):"isRecipePage"===e?.type&&e.url?((async()=>{const t=await r.storage.sync.get(["mealieUrl","mealieApiToken"]),{mealieUrl:i,mealieApiToken:a}=t;if(i&&a)try{const t=await async function(e,t,i){try{const r=new URL("/api/recipes/test-scrape-url",t),n=new AbortController,a=setTimeout(()=>n.abort(),5e3),o=await fetch(r.href,{method:"POST",headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"},body:JSON.stringify({url:e}),signal:n.signal});return clearTimeout(a),!!o.ok&&parseInt(o.headers.get("content-length")||"0",10)>500}catch(e){return!1}}(e.url,i,a);n({isRecipe:t})}catch(e){n({isRecipe:!1})}else n({isRecipe:!1})})(),!0):void 0)})();
//# sourceMappingURL=background.js.map